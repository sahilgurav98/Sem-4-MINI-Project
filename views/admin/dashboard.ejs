<%- include('../layouts/header', { title: 'Admin Dashboard' }) %>
<nav class="navbar bg-white border-bottom">
  <div class="container d-flex justify-content-between">
    <span class="navbar-brand mb-0 h1">Admin Dashboard</span>
    <form method="POST" action="/admin/logout"><button class="btn btn-outline-danger" type="submit">Logout</button></form>
  </div>
</nav>

<div class="container py-4">
  <% if (message) { %><div class="alert alert-success"><%= message %></div><% } %>
  <% if (error) { %><div class="alert alert-danger"><%= error %></div><% } %>

  <div class="row g-3">
    <div class="col-lg-4">
      <div class="card p-3 mb-3">
        <h5 class="section-title">Add Food Item</h5>
        <form method="POST" action="/admin/food-item">
          <div class="mb-2"><label class="form-label">Name</label><input class="form-control" name="name" placeholder="Masala Dosa" required /></div>
          <div class="mb-2"><label class="form-label">Price</label><input type="number" step="0.01" class="form-control" name="price" required /></div>
          <div class="mb-2"><label class="form-label">Category</label><input class="form-control" name="category" placeholder="Breakfast / Snack / Beverage" /></div>
          <div class="form-check mb-2"><input class="form-check-input" type="checkbox" name="isAvailable" checked /><label class="form-check-label">Available</label></div>
          <button class="btn btn-primary w-100" type="submit">Save Food Item</button>
        </form>
      </div>

      <div class="card p-3 mb-3">
        <h5 class="section-title">Upload Training Data (.xlsx)</h5>
        <p class="small text-muted mb-2">Text columns are accepted and encoded automatically on server.</p>
        <p class="small text-muted">Suggested columns: dayOfWeek, timeOfDay, avgDailySales, foodType, eventDay, platesRequired</p>
        <form method="POST" action="/admin/train" enctype="multipart/form-data">
          <input type="file" class="form-control mb-2" name="trainingFile" accept=".xlsx" required />
          <button class="btn btn-success w-100" type="submit">Train FNN Model</button>
        </form>
      </div>

      <div class="card p-3">
        <h5 class="section-title">Predict Food Demand</h5>
        <p class="small text-muted">Use text values. Example: Monday, Lunch, North Indian, Yes</p>
        <form method="POST" action="/admin/predict">
          <div class="mb-2"><label class="form-label">Day of Week</label><input class="form-control" name="dayOfWeek" placeholder="Monday" required /></div>
          <div class="mb-2"><label class="form-label">Time of Day</label><input class="form-control" name="timeOfDay" placeholder="Breakfast / Lunch / Dinner" required /></div>
          <div class="mb-2"><label class="form-label">Average Daily Sales</label><input type="number" class="form-control" name="avgDailySales" min="0" required /></div>
          <div class="mb-2"><label class="form-label">Food Type</label><input class="form-control" name="foodType" placeholder="Idli / Rice / Noodles" required /></div>
          <div class="mb-2"><label class="form-label">Event Day</label><input class="form-control" name="eventDay" placeholder="Yes or No" required /></div>
          <button class="btn btn-dark w-100" type="submit">Predict Plates</button>
        </form>
        <% if (prediction) { %>
          <hr />
          <p class="mb-1"><strong>Predicted Plates:</strong> <%= prediction.predictedPlates %></p>
          <p class="mb-1"><strong>Buffer Stock (10%):</strong> <%= prediction.buffer %></p>
          <p class="mb-0"><strong>Total Recommended:</strong> <%= prediction.totalRecommended %></p>
        <% } %>
      </div>
    </div>

    <div class="col-lg-8">
      <div class="card p-3 mb-3">
        <h5 class="section-title">Food Items Served in Preorder System</h5>
        <div class="table-responsive">
          <table class="table table-bordered bg-white">
            <thead class="table-light"><tr><th>Name</th><th>Category</th><th>Price</th><th>Available</th><th>Action</th></tr></thead>
            <tbody>
              <% if (!foodItems.length) { %><tr><td colspan="5" class="text-center">No food items added.</td></tr><% } %>
              <% foodItems.forEach((item) => { %>
                <tr>
                  <td><%= item.name %></td>
                  <td><%= item.category %></td>
                  <td>â‚¹<%= item.price.toFixed(2) %></td>
                  <td><%= item.isAvailable ? 'Yes' : 'No' %></td>
                  <td>
                    <form method="POST" action="/admin/food-item/<%= item._id %>/toggle">
                      <button class="btn btn-sm btn-outline-primary" type="submit">Toggle</button>
                    </form>
                  </td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
      </div>

      <div class="card p-3">
        <h5 class="section-title">Student Orders</h5>
        <div class="table-responsive">
          <table class="table table-bordered bg-white">
            <thead class="table-light">
              <tr>
                <th>Student Name</th>
                <th>Reg No</th>
                <th>Year</th>
                <th>Branch</th>
                <th>Food Item</th>
                <th>Quantity</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <% if (!orders.length) { %><tr><td colspan="8" class="text-center">No orders yet.</td></tr><% } %>
              <% orders.forEach((order) => { %>
                <tr>
                  <td><%= order.studentName %></td>
                  <td><%= order.registrationNo %></td>
                  <td><%= order.year %></td>
                  <td><%= order.branch %></td>
                  <td><%= order.foodItemName %></td>
                  <td><%= order.quantity %></td>
                  <td><span class="badge <%= order.orderStatus === 'fulfilled' ? 'bg-success' : 'bg-warning text-dark' %>"><%= order.orderStatus %></span></td>
                  <td class="d-flex gap-1">
                    <form method="POST" action="/admin/order/<%= order._id %>/fulfill">
                      <button class="btn btn-sm btn-success" type="submit">Fulfill</button>
                    </form>
                    <form method="POST" action="/admin/order/<%= order._id %>/delete">
                      <button class="btn btn-sm btn-danger" type="submit">Delete</button>
                    </form>
                  </td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
<%- include('../layouts/footer') %>
